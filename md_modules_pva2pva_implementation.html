<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>This is Unofficial EPICS BASE Doxygen Site: implementation</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script><script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="epics.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">This is Unofficial EPICS BASE Doxygen Site
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('md_modules_pva2pva_implementation.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">implementation </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>PV Access to PV Access protocol gateway (aka. proxy)</p>
<p>Theory of Operation</p>
<p>The GW maintains a Channel Cache, which is a dictionary of client side channels (shared_ptr&lt;epics::pvAccess::Channel&gt; instances) in the NEVER_CONNECTED or CONNECTED states.</p>
<p>Each entry also has an activity flag and reference count.</p>
<p>The activity flag is set each time the server side receives a search request for a PV.</p>
<p>The reference count is incremented for each active server side channel.</p>
<p>Periodically the cache is iterated and any client channels with !activity and count==0 are dropped. In addition the activity flag is unconditionally cleared.</p>
<p>Name search handling</p>
<p>The server side listens for name search requests. When a request is received the channel cache is searched. If no entry exists, then one is created and no further action is taken. If an entry exists, but the client channel is not connected, then it's activiy flag is set and no further action is taken. If a connected entry exists, then an affirmative response is sent to the requester.</p>
<p>When a channel create request is received, the channel cache is checked. If no connected entry exists, then the request is failed.</p>
<p>Structure associations and ownership</p>
<div class="fragment"><div class="line"><span class="keyword">struct </span>ServerContextImpl {</div><div class="line">  vector&lt;shared_ptr&lt;ChannelProvider&gt; &gt; providers; <span class="comment">// GWServerChannelProvider</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="dc/db2/structGWServerChannelProvider.html">GWServerChannelProvider</a> : <span class="keyword">public</span> <a class="code" href="d3/d09/classepics_1_1pvAccess_1_1ChannelProvider.html">pva::ChannelProvider</a> {</div><div class="line">  <a class="code" href="d0/d7f/structChannelCache.html">ChannelCache</a> <a class="code" href="d5/dd9/reader_8c.html#a09171f00baf289510a560e2df6d20add">cache</a>;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="d0/d7f/structChannelCache.html">ChannelCache</a> {</div><div class="line">  weak_pointer&lt;ChannelProvider&gt; server;</div><div class="line">  map&lt;string, shared_ptr&lt;ChannelCacheEntry&gt; &gt; entries;</div><div class="line"></div><div class="line">  <a class="code" href="dc/d52/namespaceepicsMutex.html">epicsMutex</a> cacheLock; <span class="comment">// guards entries</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="d8/d97/structChannelCacheEntry.html">ChannelCacheEntry</a> {</div><div class="line">  <a class="code" href="d0/d7f/structChannelCache.html">ChannelCache</a> * <span class="keyword">const</span> <a class="code" href="d5/dd9/reader_8c.html#a09171f00baf289510a560e2df6d20add">cache</a>;</div><div class="line">  shared_ptr&lt;Channel&gt; channel; <span class="comment">// InternalChannelImpl</span></div><div class="line">  set&lt;GWChannel*&gt; interested;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span>InternalChannelImpl { <span class="comment">// PVA client channel</span></div><div class="line">  shared_ptr&lt;ChannelRequester&gt; <a class="code" href="de/dd6/pvAccess_8cpp.html#a6ebbb712cd3d42946cd5eab3777029b7">requester</a>; <span class="comment">// ChannelCacheEntry::CRequester</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="d0/d8f/structChannelCacheEntry_1_1CRequester.html">ChannelCacheEntry::CRequester</a> {</div><div class="line">  weak_ptr&lt;ChannelCacheEntry&gt; chan;</div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span><a class="code" href="d1/d2d/structGWChannel.html">GWChannel</a> {</div><div class="line">  shared_ptr&lt;ChannelCacheEntry&gt; <a class="code" href="d8/df9/classentry.html">entry</a>;</div><div class="line">  shared_ptr&lt;ChannelRequester&gt; <a class="code" href="de/dd6/pvAccess_8cpp.html#a6ebbb712cd3d42946cd5eab3777029b7">requester</a>; <span class="comment">// pva::ServerChannelRequesterImpl</span></div><div class="line">};</div><div class="line"></div><div class="line"><span class="keyword">struct </span>pva::ServerChannelImpl : <span class="keyword">public</span> <a class="code" href="db/d12/classepics_1_1pvAccess_1_1ServerChannel.html">pva::ServerChannel</a></div><div class="line">{</div><div class="line">    shared_ptr&lt;Channel&gt; channel; <span class="comment">// GWChannel</span></div><div class="line">};</div></div><!-- fragment --><p>Threading and Locking</p>
<p>ServerContextImpl BeaconServerStatusProvider ?</p>
<p>2x BlockingUDPTransport (bcast and mcast, one thread each) calls ChannelProvider::channelFind with no locks held</p>
<p>BlockingTCPAcceptor BlockingServerTCPTransportCodec -&gt; BlockingAbstractCodec (send and recv threads) ServerResponseHandler calls ChannelProvider::channelFind calls ChannelProvider::createChannel calls Channel::create*</p>
<p>InternalClientContextImpl</p>
<p>2x BlockingUDPTransport (bcast listener and ucast tx/rx, one thread each)</p>
<p>BlockingTCPConnector BlockingClientTCPTransportCodec -&gt; BlockingSocketAbstractCodec (send and recv threads) ClientResponseHandler calls MonitorRequester::monitorEvent with MonitorStrategyQueue::m_mutex locked</p>
<p>TODO</p>
<p>ServerChannelRequesterImpl::channelStateChange() - placeholder, needs implementation</p>
<p>the send queue in BlockingAbstractCodec has no upper bound</p>
<p>Monitor</p>
<p>ServerChannelImpl calls <a class="el" href="d1/d2d/structGWChannel.html#a663ec0ceb39e1ae6643a0f33bb28a7a4">GWChannel::createMonitor</a> with a MonitorRequester which is ServerMonitorRequesterImpl</p>
<p>The MonitorRequester is given a Monitor which is GWMonitor</p>
<p><a class="el" href="d1/d2d/structGWChannel.html">GWChannel</a> calls InternalChannelImpl::createMonitor with a GWMonitorRequester</p>
<p>GWMonitorRequester is given a Monitor which is ChannelMonitorImpl</p>
<p>Updates originate from the client side, entering as an argument when GWMonitorRequester::monitorEvent is called, and exiting to the server when passed as an argument of a call to ServerMonitorRequesterImpl::monitorEvent.</p>
<p>When an update is added to the monitor queue ServerMonitorRequesterImpl::monitorEvent is called, as notification that the queue is not empty, which enqueues itself for transmission. The associated TCP sender thread later calls ServerMonitorRequesterImpl::send(), which calls GWMonitor::poll() to de-queue an event, which it encodes to the senders bytebuffer. It then reschedules itself. </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.11 </li>
  </ul>
</div>
</body>
</html>
